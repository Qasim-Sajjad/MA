# Use Ubuntu base image with ARM64 support
FROM ubuntu:22.04

# Set environment variables
ENV CONDA_DIR=/opt/conda \
    PATH=/opt/conda/bin:$PATH \
    DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    wget \
    bzip2 \
    ca-certificates \
    git \
    libsndfile1 \
    libportaudio2 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Install Miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh -O ~/miniconda.sh && \
    bash ~/miniconda.sh -b -p /opt/conda && \
    rm ~/miniconda.sh

# Copy environment.yml file
COPY environment.yml /tmp/environment.yml

# Create conda environment
RUN conda env create -f /tmp/environment.yml && \
    conda clean -afy

# Activate conda environment by default
SHELL ["conda", "run", "-n", "music_analysis_env_final", "/bin/bash", "-c"]

# Set working directory
WORKDIR /app

# Make sure the conda environment is activated when running the container
ENTRYPOINT ["conda", "run", "-n", "music_analysis_env_final"]

# Default command (can be overridden)
CMD ["python", "driver.py"]